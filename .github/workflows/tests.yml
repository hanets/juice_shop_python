name: Pytest Tests & Reports

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      # ── Checkout ────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Python setup ────────────────────────────────────────────────────────
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      # ── Playwright browsers ──────────────────────────────────────────────────
      - name: Install Playwright browsers
        run: playwright install --with-deps chromium

      # ── Juice Shop (target app) ──────────────────────────────────────────────
      - name: Start Juice Shop
        run: |
          docker run -d \
            --name juice-shop \
            -p 3000:3000 \
            bkimminich/juice-shop:latest
          # Wait until the app is ready
          timeout 120 bash -c 'until curl -sf http://localhost:3000; do sleep 2; done'

      # ── Run tests ────────────────────────────────────────────────────────────
      - name: Run pytest
        id: pytest
        env:
          JUICE_SHOP_BASE_URL: "http://localhost:3000"
        run: |
          set +e
          pytest \
            --html=report.html \
            --self-contained-html \
            --alluredir=allure-results \
            -v
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
        continue-on-error: true # let later steps (reports) always run

      # ── Upload reports ───────────────────────────────────────────────────────
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-html-report
          path: report.html
          retention-days: 30

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results/
          retention-days: 30

      # ── Generate & publish Allure report (GitHub Pages) ──────────────────────
      - name: Install Allure CLI
        if: always()
        run: |
          curl -o allure.tgz -Ls \
            https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxf allure.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure

      - name: Generate Allure HTML report
        if: always()
        run: allure generate allure-results --clean -o allure-report

      - name: Upload Allure HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-html-report
          path: allure-report/
          retention-days: 30

      - name: Publish Allure report to GitHub Pages
        if: >
          always() &&
          (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report
          force_orphan: true # creates branch from scratch if it doesn't exist
          enable_jekyll: false # serve Allure HTML as-is, no Jekyll processing

      # ── Fail the build if tests failed ────────────────────────────────────────
      - name: Assert tests passed
        if: always()
        run: |
          exit_code="${{ steps.pytest.outputs.exit_code }}"
          if [ "$exit_code" != "0" ]; then
            echo "Tests failed (exit code $exit_code). Marking build as failed."
            exit 1
          fi
